
# Main installation definition
server {
	listen		80;
	server_name	.alysiaworld.com .bmoore.wpengine.com;
	root		/nas/wp/www/cluster-1621/bmoore;

	# The WP Engine standard log format, short, easy to process, has backend info and timings.
	access_log	/var/log/nginx/bmoore.access.log	wpengine;
	# The weblogs in Apache Standard format, for users to download.
	access_log	/var/log/nginx/bmoore.apachestyle.log	apachestandard;


	# Determine whether this is a known bot
	set $is_bot 0;
	if ( $http_user_agent ~* "bot|facebook|crawler|feed|flipboard|slurp|re(?:e|a)der|spider|scoutjet|ssowl|site24|google|news|pubsub|^expo9|^tzogeoagent|jakarta" ) {
		set $is_bot 1;
	}

	# Determine whether this is a mobile agent
	set $is_ua_mobile 0;
	if ( $http_user_agent ~* "acer\ s100|archos5|cupcake|docomo\ ht\-03a|dream|htc\ hero|htc\ magic|htc_dream|htc_magic|incognito|lg\-gw620|liquid\ build|maemo|mot\-mb200|mot\-mb300|nexus\ one|opera\ mini|samsung\-s8000|series60.*webkit|series60/5\.0|sonyericssone10|sonyericssonu20|sonyericssonx10|t\-mobile\ mytouch\ 3g|t\-mobile\ opal|tattoo|webmate|2\.0\ mmp|240x320|alcatel|amoi|asus|au\-mic|audiovox|avantgo|benq|blackberry|blazer|cellphone|danger|ddipocket|docomo|dopod|elaine/3\.0|ericsson|eudoraweb|haier|hiptop|hp\.ipaq|htc|huawei|i\-mobile|iemobile|j\-phone|kddi|konka|kwc|kyocera/wx310k|lg/u990|lge\ vx|midp|midp\-2\.0|mmef20|mobilephone|mot\-v|motorola|netfront|newgen|newt|nintendo\ ds|nintendo\ wii|nitro|nokia|novarra|openweb|opera[\s\.]mobi|palm|panasonic|pantech|pdxgw|philips|\bphone\b|playstation\ portable|portalmmm|proxinet|psp|qtek|sagem|samsung|sanyo|sendo|sharp|sharp\-tq\-gx10|smartphone|softbank|sonyericsson|symbian|symbian\ os|symbianos|toshiba|treo|ts21i\-10|up\.browser|up\.link|vertu|vodafone|willcome|windows[ \.]ce|winwap" ) {
		set $is_ua_mobile 1;
	}
	if ( $http_user_agent ~* "android|iphone|ipod|itouch" ) {
		set $is_ua_mobile 1;
	}
	if ( $http_user_agent ~* "\bipad\b" ) {
		set $is_ua_mobile 1;
	}

		
	### Rewrite Rules ### (none configured) ###

	# Queryargs we don't want to allow (mostly injection-style attacks)
	if ( $args ~* "(?:\<|%3c).*script.*(?:\>|%3e)|\b(?:GLOBALS|_REQUEST|_GET|_POST|_COOKIE)(?:=|\[|\%[0-9A-Z]{0,2})" ) {
		return 403;
	}

	# Bots which blast sites and we don't want to allow them.
	if ( $http_user_agent ~* "^\W|^Mozilla(?: |/2|/4\.0\+?\()|^(?:LWP|MSIE|Nut|Omniexpl|Opera/9\.64|pussycat|python|super happy|trackback/|user|website-|winnie)|[\r\n]|psyche|adwords|\bemail|autoemailspider|core-project|diamond|digger|ecollector|forum|^java[/ ]\d\.|Microsoft URL|Missigua|Movable Type|grub|httpproxy|Internet Explorer|isc systems|blogsearch|cherrypicker|maxpoint|casper|boston|feedfinder|mj12bot|cmsworldmap|diavol|dotbot|flicky|ia_archiver|kmccrew|libwww|planetwork|pycurl|skygrid|; Widows|a href|DTS agent|user-agent:|hanzoweb|indy lib|murzillo|\.NET CLR 1\)|POE-Component-Client|turing mach|Ubuntu/9\.25|unspecified\.mail|webaltbot|wise(?:nut)?bot|Windows NT [45]\.[01];\)|Windows XP 5|WordPress/4\.01|discobot|xedant|\\\\" ) {
		return 403;
	}


	# If this is a bot AND the path or query args are such that bots should get a 301 away from
	# this resource, do that immediately.
	set $bot_path "$is_bot$uri";
	if ( $bot_path ~ "^1.*?(?:/page/\d\d+|/attachment/|/search/|/members/[^/]+/activity|/activity/p/)" ) {
		set $args "";
		rewrite ^	/	permanent;
	}
	if ( $bot_path ~ "^1.*?(?:[a-zA-Z](?<!/page)/\d+)/?$" ) {
		rewrite	^(.*)/[^/]+/?$	$1	permanent;
	}
	set $is_bot_ok 0;
	set $bot_ok_regex "$is_bot$is_args$args";
	if ( $bot_ok_regex ~ "^1\?(?:p=\d+|feed=)" ) {
		set $is_bot_ok 1;
	}
	set $is_bot_redirect "$is_bot$is_args$is_bot_ok";
	if ( $is_bot_redirect = "1?0" ) {		# is a bot, but not OK -- redirect without query args
		set $args "";
		rewrite ^	$uri	permanent;
	}

	# Decide whether this request is "trusted," i.e. is allowed to write PHP to disk.
	# The vast majority of requests are untrusted, in that they're unauthenticated and
	# could represent a hacker trying to manipulate something.  Trusted requests are
	# allowed to do more to the filesystem.
	set $is_trusted 0;
	if ( $http_cookie ~ "\bwpe-auth=01026b886e22bb80877f1f555877a8b9\b" ) {		# Our plugin sends this when the user is in fact authenticated for admin work
		set $is_trusted 1;
	}
	if ( $is_from_managewp = 1 ) {	# ManageWP, who POSTs to /index.php
		set $is_trusted 1;
	}
	if ( $uri ~ "/wp-content/plugins/(?:si-captcha-for-wordpress|contact-form-7)|^/importbuddy\.php$" ) {		# Set of paths we ought to trust
		set $is_trusted 1;
	}
	if ( $http_host ~ "\.staging\.wpengine\.com$" ) {	# No need for all this if we're in the staging area
		set $is_trusted 0;
	}

	# Check for paths which are 403 when untrusted
	set $is_untrusted_path "$is_trusted,$uri";
	if ( $is_untrusted_path ~ "^0,.*?/uploadify.*(?<!\.js|\.css)$" ) {
		return 403;
	}

	# Append the rewrite info to the User Agent if it exists
	set $my_ua $http_user_agent;
	if ( $http_x_wpe_rewrite != "" ) { set $my_ua "$http_user_agent; X-WPE-Rewrite=$http_x_wpe_rewrite"; }


	# Custom 503 error page
	location  = /--intentional503-- {
		root	/nas/wp/www/common/production;
		rewrite ^       /intentional-site-500.html      break;
	}

	# If the "all to 500" sentinal file is there, make all pages be a 500-error
	if ( -e /nas/wp/www/cluster-1621/bmoore/_wpeprivate/disable-site ) {
		rewrite ^ /--intentional503-- last;
	}


	# Secure way for user to download current nginx log file
	location = /bmoore/03e4731d44c29a0c52505781175960d579612334/logs/current.log {
		access_log off;
		log_not_found off;
		add_header	Cache-Control	"private, no-cache, max-age=0";
		root /var/log/nginx;
		rewrite ^ /bmoore.apachestyle.log break;
	}
	# Secure way for user to download current nginx log file
	location = /bmoore/03e4731d44c29a0c52505781175960d579612334/logs/previous.log {
		access_log off;
		log_not_found off;
		add_header	Cache-Control	"private, no-cache, max-age=0";
		root /var/log/nginx;
		rewrite ^ /bmoore.apachestyle.log.1 break;
	}

	# These paths are known to us to always be a 404, confirmed with the client.
	# They get a lot of traffic, so it's useful to be efficient about rejecting
	# the data and not filling the log with crap.
	location ~ "^/nas/wp\\b|^/nginx_status|/undefined/?$|/plugins/wp-postviews/wp-postviews\\.php|^/cgi-bin|/autodiscover\\.xml"	{
		access_log off;
		log_not_found off;
		return 404;
	}

	# These paths are illegal because they're special control files that should
	# never be accessed by a web server
	location ~ "/\\.(?:htaccess|svn|cvs|git|smushit-status|largefs)|\\.(?:as.x)$|r\\d+shell|/wp-content/mysql\\.sql|/uploads/(?:temp|backupbuddy)_|/wp-content/plugins/tweet-blender/|^/sd_nginx_status|^/_wpeprivate|/php-?(?:my)?-?admin|/pma/?$|^/readme.htm"	{
		access_log off;
		log_not_found off;
		return 403;
	}

	# robots.txt is special. If it exists on disk, serve that one directly.
	# Otherwise pass it through to WordPress, via cached in Varnish.
	location = /robots.txt	{
		add_header		X-Type	"robots";
		add_header		Cache-Control  "public, max-age=2592000";
		log_not_found		off;
		if_modified_since       before;
		error_page		403 = @varnishforever;
		error_page		404 = @varnishforever;
	}

	# Feeds are cached by Varnish.
	location ~ /(?:atom(?:/|\.xml)?(?:/index.php)?|feed(?:/|\.xml|/rss2?\b/?|/rdf/?|/podcast/?)?(?:/index\.php|.+\.xml)?|index\.rdf)$		{
		add_header			X-Type	"feed";
		proxy_set_header	X-Cache-Always	"feed";
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua;  proxy_pass http://localhost:9002;
	}




	# Certain paths can be cached as long as we want, either because they literally never change or it's
	# OK if the change takes hours to take effect, *and* don't care about any request parameters like
	# user-agent or logged-in or cookies.  In these cases, use nginx to cache rather than Varnish.
	location ~ "/(?:php|[tT]im)?[tT]humb(?:nail)?\\.(?:php|bmp)$|/ima?ge?\\.php$|[^a-zA-Z0-9](?:css|js|scripts?|style(?:sheet)?s?|j(?:ava)?scripts?)\\.php$|/plugins/b?wp-minify/min|/plugins/sidebartabs/styleSidebar_global\\.php$|/plugins/s2member/s2member-o\\.php$|/shopp?/images?/\\d+/?|/gradient\\.php$|^/robots\\.txt$" {
				### MU Rules ###(none)###
		add_header		X-Type	"long-cache";
		if_modified_since       before;
		add_header		Cache-Control  "public, max-age=2592000";
		add_header		Vary "Accept-Encoding";
		add_header		Access-Control-Allow-Origin *;

		proxy_cache         foreverzone;
		proxy_cache_key     "$request_method:$http_host$uri$is_args$args";	# need all this, else will collide or cache wrong content!
		proxy_cache_valid	1d;
		proxy_cache_use_stale   error timeout updating invalid_header http_500 http_502 http_503 http_504;

		proxy_connect_timeout   	10s;
		proxy_max_temp_file_size	1m;		# max size before we just stream it back
		proxy_intercept_errors		off;	# should be "on" and we should have a good error page
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua; proxy_pass http://localhost:9002;
	}


	# A few static files we not only serve directly, we handle 404s ourselves.
	# Careful, it's easy to break someone by directly returning 404 when it's really there.
	location ~ "/favicon\\.\\w+$|/apple-touch-icon[^/]*\\.png$|/crossdomain\\.xml$|^/PointRollAds\\.htm|^/doubleclick/DARTIframe\\.html|^/wp-includes/wlwmanifest\\.xml|^/(?:wp-content/(?:themes|plugins|uploads|wptouch-data|gallery)|wp-includes|wp-admin)/.*\\.(?:jpe?g|gif|png|css|js|ico|zip|7z|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|midi?|wav|bmp|rtf|avi|mp\\d|mpg|iso|mov|djvu|dmg|flac|r70|mdf|chm|sisx|sis|flv|thm|bin|swf|cert|otf|ttf|eot|svgx?|woff|jar|class)$"  {
				### MU Rules ###(none)###
		rewrite		^/[^/]+(/wp-(?:admin|includes)/.+)$		$1	break;		# support multisite wp-admin semantics; ticket 37285
		add_header		X-Type	"static/known";
		log_not_found		off;
		if_modified_since       before;
		add_header		Cache-Control  "public, max-age=2592000";
		add_header		Vary "Accept-Encoding";
		add_header		Access-Control-Allow-Origin *;
	}

	# Serve static files directly; missing files need to hit the backend in case they're
	# created dynamically (i.e. minify) or have a rewrite rule (e.g. Multisite or custom rewrite).
	location ~* ^.+\.(?:jpe?g|gif|png|css|js|ico|zip|7z|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|midi?|wav|bmp|rtf|avi|mp\d|mpg|iso|mov|djvu|dmg|flac|r70|mdf|chm|sisx|sis|flv|thm|bin|swf|cert|otf|ttf|eot|svgx?|woff|jar|class)$  {
				### MU Rules ###(none)###
		add_header		X-Type	"static/generic";
		if_modified_since       before;
		add_header		Cache-Control  "public, max-age=2592000";
		add_header		Vary "Accept-Encoding";
		add_header		Access-Control-Allow-Origin *;
	}

	# An internal redirect target for a backend request.
	location @backend {
		add_header		X-Type	"backend";
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua; proxy_pass http://localhost:9002;
	}

	# An internal redirect target for varnish-cache using "forever" rules
	location @varnishforever {
		add_header		X-Type	"varnish-forever";
		proxy_set_header	X-Cache-Always	"forever";
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua;  proxy_pass http://localhost:9002;
	}

	# A rewrite target to use Varnish caching for a small number of hours.
	location /-varnish-hours-	{
		add_header			X-Type	"varnish-hours";
		proxy_set_header	X-Cache-Always	"hours";
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua;  proxy_pass http://localhost:9002;
	}

	# A rewrite target to use Varnish caching for a very short time and honoring everything else.
	location /-varnish-short-	{
		add_header			X-Type	"varnish-short";
		proxy_set_header	X-Cache-Short	"yes";
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua;  proxy_pass http://localhost:9002;
	}


	# Default is to send the result to the Apache backend with a
	# standard IP-based rate-limit suitable for public consumption.
	location / {
		add_header		X-Type		"default";
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua;

		### MU Rules      ###(none)###

			# Verify login is being submitted via login form and not remote attack
		# If it's a login attempt
		set $wpe_login_attempt 0;
		if ( $uri ~ /wp-login\.php ) {
			set $wpe_login_attempt 1;
		}
		# If it provides the correct login flag
		set $wpe_login_valid 0;
		if ( $args ~ "wpe-login" ) {
			set $wpe_login_valid 1;
		}
		# If it's a POST request and the other args don't match, reject
		set $login_attempt "$request_method:$wpe_login_attempt:$wpe_login_valid";
		if ( $login_attempt = "POST:1:0" ) {
			return 444;
		}
	


		# If this request is trusted, and dynamic, skip Varnish and hit the special Apache port
		if ( $is_trusted = 1 ) {
						break;
			proxy_pass http://localhost:6788;
		}

		# If it's not a GET or HEAD, Varnish isn't going to cache it anyway, so just go straight to Apache.
		if ( $request_method !~* "get|head" ) {
						break;
			proxy_pass http://localhost:6789;
		}

		# Certain actually-static files are generated by code, especially from plug-ins.
		# Use Varnish to cache these for a short while.
		if ( $uri ~ /xd_receiver\.htm$|/featured-content-gallery/(?:css|scripts)/jd\.gallery\.(?:css|js)\.php$|/ozh-admin-drop-down-menu/inc/adminmenu\.css\.php$ ) {
			rewrite		^(.*)$		/-varnish-hours-$1		last;
		}
		if ( $args ~ (?:mcsf_action=main_css|ak_action=aktt_(?:css|js)|sjsl=|cf_action=cfmobi_admin_(?:js|css)|apipp_style=|action=shadowboxjs|s=jquery-comment-preview\.js) ) {
			rewrite		^(.*)$		/-varnish-hours-$1		last;
		}

		# Certain plugins or services hit us a lot and need to be cached by Varnish,
		# even if it means serving old content.  Like comment-sync and ad services.
		if ( $arg_cf_action = "sync_comments" ) {						# Disqus
			rewrite		^(.*)$		/-varnish-short-$1		last;
		}
		if ( $http_user_agent ~ "ClickSense" ) {						# ValueClick/ClickSense, http://www.lucidmedia.com
			rewrite		^(.*)$		/-varnish-short-$1		last;
		}
		if ( $args ~ "(?:\bnggpage=)" ) {
			rewrite		^(.*)$		/-varnish-short-$1		last;
		}

		# Paths where Varnish shouldn't cache; therefore just skip Varnish
		if ( $uri ~ "(^/(?!.))" ) {
			add_header		X-Type		"nocachepath";
						break;
			proxy_pass http://localhost:6789;
		}

				proxy_pass http://localhost:9002;
	}

}

# Fast 301-redirect for 1 alias domains back to primary domain alysiaworld.com.
server {
	listen		80;
	server_name	www.alysiaworld.com;

	location / {
		rewrite		^(.*)	http://alysiaworld.com$1	permanent;
	}
}

# Staging area
server {
	listen			80;
	server_name		.bmoore.staging.wpengine.com;
	root			/nas/wp/www/staging/bmoore;

	# Append the rewrite info to the User Agent if it exists
	set $my_ua $http_user_agent;
	if ( $http_x_wpe_rewrite != "" ) { set $my_ua "$http_user_agent; X-WPE-Rewrite=$http_x_wpe_rewrite"; }


	### Rewrite Rules ### (none configured) ###

	# These paths are known to us to always be a 404, confirmed with the client.
	# They get a lot of traffic, so it's useful to be efficient about rejecting
	# the data and not filling the log with crap.
	location ~ "^/nas/wp\\b|^/nginx_status|/undefined/?$|/plugins/wp-postviews/wp-postviews\\.php|^/cgi-bin|/autodiscover\\.xml"	{
		access_log off;
		log_not_found off;
		return 404;
	}

	# These paths are illegal because they're special control files that should
	# never be accessed by a web server
	location ~ "/\\.(?:htaccess|svn|cvs|git|smushit-status|largefs)|\\.(?:as.x)$|r\\d+shell|/wp-content/mysql\\.sql|/uploads/(?:temp|backupbuddy)_|/wp-content/plugins/tweet-blender/|^/sd_nginx_status|^/_wpeprivate|/php-?(?:my)?-?admin|/pma/?$|^/readme.htm"	{
		access_log off;
		log_not_found off;
		return 403;
	}

	# Override robots.txt so bots never scan us
	location ~ ^/(robots\.txt|\.xml(\.gz)?)$	{
		root		/nas/wp/www/common/staging;
		expires		30d;
		add_header	X-Type	"staging-version";
	}

	location / {
		proxy_set_header Host $http_host;proxy_set_header X-Real-IP $remote_addr;proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header X-LB-Key "bmoore";proxy_set_header X-Is-Bot $is_bot;proxy_set_header User-Agent $my_ua;
		### MU Rules ###(none)###
		### MU Rules      ###(none)###
				proxy_pass			http://localhost:6789;		# never Varnish!
	}

#	# Serve static files directly; missing files need to hit the backend in case they've just appeared.
#	location ~* ^.+\.(?:jpe?g|gif|png|css|js|ico|zip|7z|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|midi?|wav|bmp|rtf|avi|mp\d|mpg|iso|mov|djvu|dmg|flac|r70|mdf|chm|sisx|sis|flv|thm|bin|swf|cert|otf|ttf|eot|svgx?|woff|jar|class)$  {
#		add_header		X-Type	"static/backed";
#		# For special fonts loaded from CDN.
#		add_header		Access-Control-Allow-Origin *;
#		log_not_found	off;
#		expires			1d;
#		error_page		403 = /index.php?q=$request_uri;
#		error_page		404 = /index.php?q=$request_uri;
#	}

} # staging
